// ==UserScript==
// @name         SVG Path Width ğŸ”µ
// @namespace    http://tampermonkey.net/
// @version       0.2
// @description  ç·¨é›†ç”»é¢ã®pathã‚³ãƒ¼ãƒ‰ã®å¹…ã‚’ä¿®æ­£ã™ã‚‹ã€€ï½¼ï¾–ï½°ï¾„ï½¶ï½¯ï¾„ã€ŒF9ã€
// @author        Ameba Blog User
// @match        https://*/*
// @run-at        document-start
// @grant         none
// ==/UserScript==



if(!location.hostname.includes('example.net')){
    window.addEventListener('keydown', check_key);
    function check_key(event){
        if(event.keyCode==120){ // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã€ŒF9ã€
            event.preventDefault();
            event.stopImmediatePropagation();
            let win_apper='left=100, top=100, width=1024, height=400';
            window.open('https://example.net/', null , win_apper); }}}
else{
    env();
    setTimeout(()=>{
        main();
    }, 300); }


function env(){
    let head=document.head;
    if(head){
        let lang='<meta http-equiv="Content-Language" content="ja">';
        head.insertAdjacentHTML('beforeend', lang);

        let pre_style=head.querySelector('style');
        if(pre_style){
            pre_style.remove(); }}

    setTimeout(()=>{
        let pre_div=document.querySelector('body > div');
        if(pre_div){
            pre_div.remove(); }
    }, 200);

} // env()



function main(){
    let row_count=80; // ã‚³ãƒ¼ãƒ‰1è¡Œã®æ–‡å­—æ•°
    let pre_code; // ç·¨é›†æ ã®ã‚³ãƒ¼ãƒ‰
    let stack_g=[]; // ã‚³ãƒ¼ãƒ‰æ–‡å­—ã®å–å¾—ç”¨ã®é…åˆ—
    let stack_o=[]; // ã‚³ãƒ¼ãƒ‰æ–‡å­—ã®å‡ºåŠ›ç”¨ã®é…åˆ—


    let help_url='https://ameblo.jp/personwritep/entry-12872543694.html'

    let SVG_h=
        '<svg class="svg_help" height="22" width="22"  viewBox="0 0 200 200">'+
        '<path d="M89 22C71 25 54 33 41 46C7 81 11 142 50 171C58 177 68 182 78 18'+
        '5C90 188 103 189 115 187C126 185 137 181 146 175C155 169 163 162 169 153'+
        'C190 123 189 80 166 52C147 30 118 18 89 22z" style="fill:#888;"></path>'+
        '<path d="M67 77C73 75 78 72 84 70C94 66 114 67 109 83C106 91 98 95 93 10'+
        '1C86 109 83 116 83 126L111 126C112 114 122 108 129 100C137 90 141 76 135'+
        ' 64C127 45 101 45 84 48C80 49 71 50 68 54C67 56 67 59 67 61L67 77M85 143'+
        'L85 166L110 166L110 143L85 143z" style="fill:#fff;"></path>'+
        '</svg>';

    let base=
        '<div id="base_board">'+
        '<style>'+
        '#base_board { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; '+
        'z-index: 1; background: #9ab6c8; } '+
        '</style>'+
        '</div>'+
        '<div class="code_panel">'+
        '<div class="control">'+
        '<a href="'+ help_url +'" target="_blank" rel="noopener noreferrer">'+
        SVG_h +'</a>'+
        '<input class="tab_clear" type="submit" value="Tab Clear">ã€€'+
        '<span>Characters / lineï¼š'+
        '<input class="row" type="number" min="20" max="200"></span>ã€€ã€€'+
        '<input class="out_copy" type="submit" value="Copy Code">'+
        '</div>'+
        '<pre contenteditable="true"></pre>'+
        '<style>'+
        '.code_panel { position: relative; top: 20px; margin: 0 auto;'+
        'font: normal 16px/20px Meiryo; width: fit-content; min-width: 600px; '+
        'background: #fff; border: 2px solid #2196f3; z-index: 4; } '+
        '.code_panel .control { display: flex; justify-content: space-evenly; '+
        'padding: 6px 0 5px; border-top: 1px solid #333; border-bottom: 1px solid #333; '+
        'background: #c7e5fc; } '+
        '.code_panel .control .svg_help { vertical-align: -11px; } '+
        '.code_panel .control input { font: normal 16px/24px Meiryo; padding: 2px 8px 0; } '+
        '.code_panel .control .row { width: 50px; padding: 2px 4px 0 12px; vertical-align: 0; } '+
        '.code_panel pre { '+
        'font: normal 16px/20px Meiryo; margin: 0; padding: 20px 30px; '+
        'max-height: calc(100vh - 165px); overflow-y: scroll; } '+
        '.code_panel pre:focus { outline: none; } '+
        '</style></div>';

    if(!document.querySelector('.code_panel')){
        document.body.insertAdjacentHTML('beforeend', base); }


    pre_work();


    function pre_work(){
        let tab_clear=document.querySelector('.tab_clear');
        let pre=document.querySelector('.code_panel pre');
        if(tab_clear && pre){
            tab_clear.onclick=function(){
                pre_code=pre.textContent;
                if(pre_code){
                    get_text(pre_code);
                    let stack_str=stack_g.join('');
                    pre.textContent=output(stack_str);
                    outpanel_set(); }}}

    } // pre_work()



    function get_text(text){
        let count=text.match(/'/g).length
        if(count%2==1){ //ã€Œ'ã€ã«ç«¯æ•°ãŒã‚ã‚‹
            alert("å‡¦ç†å¯¾è±¡ã‚³ãƒ¼ãƒ‰ã®åˆ‡å‡ºã—æ–¹ã«å•é¡Œã‚ã‚Š ã€Œ'ã€ãŒå¥‡æ•°ã§ã™"); }
        else{
            let top_str=text.substring(0, text.indexOf("'"));
            if(top_str){ // æœ€åˆã®ã€Œ'ã€ã‚ˆã‚Šæ‰‹å‰ã«æ–‡å­—ãŒã‚ã‚‹
                top_str=top_str.replace(/\s/g,'');
                if(top_str.length>0){ // æœ€åˆã®ã€Œ'ã€ã‚ˆã‚Šæ‰‹å‰ã«åŠè§’ç©ºç™½ä»¥å¤–ã®æ–‡å­—ãŒã‚ã‚‹
                    alert("å‡¦ç†å¯¾è±¡ã‚³ãƒ¼ãƒ‰ãŒã€Œ' 'ã€ã®ä¸­ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã¾ã™"); }
                else{ // æœ€åˆã®ã€Œ'ã€ã‚ˆã‚Šæ‰‹å‰ã«åŠè§’ç©ºç™½ä»¥å¤–ã®æ–‡å­—ãŒãªã„
                    clean(text); }}
            else{ // æœ€åˆã®ã€Œ'ã€ã‚ˆã‚Šæ‰‹å‰ã«æ–‡å­—ãŒãªã„
                clean(text); }


            function clean(text){
                stack_g=[]; // ã‚³ãƒ¼ãƒ‰æ–‡å­—ã®é…åˆ—ã‚’ãƒªã‚»ãƒƒãƒˆ
                for(let index=0; true;){
                    let s=text.indexOf("'", index); // indexä½ç½®ã‹ã‚‰æ¤œç´¢
                    if(s==-1){ break; } //ã€Œ'ã€ãŒãªã‘ã‚Œã°çµ‚äº†
                    let e=text.indexOf("'", s+1); // ç™ºè¦‹ã—ãŸä½ç½®ã‚ˆã‚Šå¾Œæ–¹ã®ã€Œ'ã€ã‚’æ¤œç´¢
                    if(e==-1){ break; } //ã€Œ'ã€ãŒãªã‘ã‚Œã°çµ‚äº†
                    stack_g.push(text.substring(s+1, e)); // s e ã®ä½ç½®ã‚’åˆ‡å‡ºã™
                    index=e+1; }
                return stack_g; }}

    } // get_text()



    function outpanel_set(){
        let row=document.querySelector('.row');
        if(row){
            row.value=row_count;
            row.onchange=function(){
                edit_row(row.value*1); }}

        function edit_row(row_set){
            if(19<row_set && row_set<201){ // æ–‡å­—æ•°ã¯ 20ï½ 200
                row_count=row_set;
                let pre=document.querySelector('.code_panel pre');
                if(pre){
                    pre.textContent=output(); }}}

        window.addEventListener('keydown', (event)=>{ // â‡§â‡©ã‚­ãƒ¼ã§ inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            if(event.keyCode==40 || event.keyCode==38){
                let row=document.querySelector('.row');
                if(row){
                    row.focus(); }}});


        let out_copy=document.querySelector('.out_copy');
        if(out_copy){
            out_copy.onclick=function(){
                copyToClipboard(output()); }

            function copyToClipboard(value){
                if(navigator.clipboard){ // navigator.clipboardãŒä½¿ãˆã‚‹ã‹åˆ¤å®šã™ã‚‹
                    return navigator.clipboard.writeText(value).then(function(){ // ã‚³ãƒ”ãƒ¼
                        out_copy.style.boxShadow='inset 0 0 0 20px #2196f350';
                        out_copy.style.outline='2px solid #fff';
                        setTimeout(()=>{
                            out_copy.style.boxShadow='';
                            out_copy.style.outline='';
                        }, 1000);
                    }); }}}

    } // outpanel_set()



    function output(stack_str){
        stack_g=[]; // ãƒªã‚»ãƒƒãƒˆ
        stack_o=[]; // ãƒªã‚»ãƒƒãƒˆ

        let pre=document.querySelector('.code_panel pre');
        if(pre){
            pre_code=pre.textContent;
            if(pre_code){
                get_text(pre_code);
                let stack_str=stack_g.join('');

                findText(stack_str); // ã‚¿ã‚°è¨˜å·ã§åŒºåˆ‡ã‚‹

                for(let k=0; k<stack_o.length; k++){ // pathã‚¿ã‚°ã¯å…¥ã‚Œå­ã«ãªã‚‰ãªã„ã®ã§çºã‚ã‚‹
                    if(stack_o[k].startsWith('<path') && stack_o[k+1]=='</path>'){
                        stack_o[k] +='</path>';
                        stack_o[k+1]=''; }}

                stack_o=stack_o.filter(item=>{
                    return item!=''; });

                for(let k=0; k<stack_o.length; k++){ // row_countã®æ–‡å­—ãšã¤ã®è¡Œã«åŒºåˆ‡ã‚‹
                    stack_o[k]=break_words(stack_o[k]); }

                return stack_o.join('\n').slice(0, -1) +';'; }} // ç¹‹ã„ã§æœ«å°¾ã®ã€Œ+ã€ã‚’ã€Œ;ã€ã«å¤‰æ›´


        function findText(text){
            for(let index=0; true;){
                let s=text.indexOf('<', index); // indexä½ç½®ã‹ã‚‰æ¤œç´¢
                if(s==-1){ break; } // '<' ã‚’è¦‹ã¤ã‘ãŸã‚‰å¾Œæ–¹ã®å‡¦ç†ã¸
                let e=text.indexOf('>', s +1); // ç™ºè¦‹ã—ãŸä½ç½®ã‚ˆã‚Šå¾Œæ–¹ã®'>'ã‚’æ¤œç´¢
                if(e==-1){ break; } // '>' ã‚’è¦‹ã¤ã‘ãŸã‚‰å¾Œæ–¹ã®å‡¦ç†ã¸
                stack_o.push('<'+ text.substring(s +1, e) +'>'); // s e ã®ä½ç½®ã‚’åˆ‡å‡ºã™
                index=e +1; }
            return stack_o; }


        function break_words(source_code){
            let s_arr=[];
            for (let i=0; i<source_code.length; i+=row_count){ // ã‚³ãƒ¼ãƒ‰1è¡Œã®æ–‡å­—æ•°ã®æŒ‡å®š
                s_arr.push(source_code.slice(i, i+row_count)); }

            let new_s_arr=[];
            for (let i=0; i<s_arr.length; i++){
                let row="'"+ s_arr[i] +"'+";
                new_s_arr.push(row); }

            return new_s_arr.join('\n'); }

    } // output()

} // main()




